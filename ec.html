<html lang="en" dir="ltr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>EU Integrity Watch</title>
<link rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" type="text/css" href="css/dc.css"/>
<!--link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"-->
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/material.css" rel="stylesheet">
<link href="css/theme.bootstrap.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/style.css"/>


<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the pdate via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->

<!--script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.min.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
<script src="js/d3-tip.min.js"></script-->

<script src="js/jquery.min.js"></script>
<script src="js/jquery.tablesorter.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/d3.js" charset="utf-8"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/underscore-min.js"></script>
<script src="js/d3-tip.min.js"></script>

<script src="js/jquery.min.js"></script>
<script src="js/jquery.tablesorter.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<style>
td.dc-table-column._4,
td.dc-table-column._5,
td.dc-table-column._6
{text-align:left;}

#mep_number {
    margin-top: 0.1em;}
</style>

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@TI_EU" />
<meta name="twitter:creator" content="@eucampaign" />

<meta property="og:url" content="http://www.integritywatch.eu" />
<meta property="og:title" content="EU Integrity Watch: monitor potential conflicts of interests" />
<meta property="og:description" content="Interactive database that provides a unique overview of the activities and outside income for the members of the European Parliament and Commission" />
<meta property="og:imdate" content="http://www.integritywatch.eu/img/thumbnail.jpg" />

</head>
<body>


<script>
$( document ).ready(function() {
	$('#view_charts').click(function(ev) {
		ev.preventDefault();
		$('#hidden_charts_wrap').slideToggle('slow', function () {
			changeLinkStatus();
		})
	})
	
	function changeLinkStatus() {
		if($('#hidden_charts_wrap').css('display') == 'none'){
			$('#view_charts').text('VIEW ALL THE CHARTS')
		}else {
			$('#view_charts').text('HIDE CHARTS')
		}
		$('#view_charts').toggleClass('hiddencharts');
	}
	
	$('#collapse_about a').click(function(ev) {
		ev.preventDefault();
		$('#collapse_about a').toggleClass('opened');
		$('#about_wrap').slideToggle('slow', function () {
			
		})
	})
	
	$('.info').click(function(ev) {
		ev.preventDefault();
		if($(this).hasClass('opened')){
			$(this).removeClass('opened');
			$(this).parents('.info_chart').find('p.desc').slideUp('fast')
		}else{
			closeAllInfos();
			$(this).addClass('opened');
			$(this).parents('.info_chart').find('p.desc').slideDown('fast')
		}
	});
	
	function closeAllInfos() {
		$('.info').removeClass('opened');
		$('p.desc').slideUp('fast');
	}
	
});

$.tablesorter.addParser({
  // use a unique id
  id: 'amount',
  is: function(s, table, cell) {
    return false;
  },
  format: function(s, table, cell, cellIndex) {
    var v = s.split(' ')[0];
    if (v === "") return -1;
    return v;
  },
  // flag for filter widget (true = ALWAYS search parsed values; false = search cell text)
  parsed: false,
  // set the type to either numeric or text (text uses a natural sort function
  // so it will work for everything, but numeric is faster for numbers
  type: 'numeric'
});

var detailtpl = sidetpl = null ;

var wall = null;


function grid (selector,data) {

  var ndx = crossfilter(data),
      all = ndx.groupAll();

  var color = d3.scale.linear()
        .clamp(true)
        .domain([0,1, 70])
        .range(["white","#ffc7b6", "#f85631"])
        .interpolate(d3.interpolateHcl);

var mainCategories = {"1":"Consultants","2":"Corporate","3":"NGOs","4":"Think tanks ","5":"Churches ","6":"Municipal"};

var subCategories = {"11":"Professional consultancies","12":"Law firms","13":"Self-employed consultants","21":"Companies & groups","22":"Trade and business associations","23":"Trade unions","24":"Other organisations","31":"Non-governmental organisations, platforms and networks and similar","41":"Think tanks and research institutions","42":"Academic institutions","51":"Organisations representing churches and religious communities","61":"Local, regional and municipal authorities (at sub-national level)","62":"Other public or mixed entities, etc.","444":"Trade unions and professional associations","446":"Trade unions and professional associations","450":"Regional structures","458":"Other public or mixed entities, created by law whose purpose is to act in the public interest","466":"Trade unions and professional associations","469":"Trade unions and professional associations","477":"Other public or mixed entities, created by law whose purpose is to act in the public interest","480":"Trade unions and professional associations","501":"Trade unions and professional associations","504":"Other public or mixed entities, created by law whose purpose is to act in the public interest","506":"Trade unions and professional associations","508":"Trade unions and professional associations","5055":"Trade unions and professional associations","5060":"Trade unions and professional associations","5062":"Other public or mixed entities, created by law whose purpose is to act in the public interest","5065":"Trade unions and professional associations","5073":"Trade unions and professional associations","5074":"Regional structures","5075":"Trade unions and professional associations","5085":"Regional structures","5087":"Trade unions and professional associations","5089":"Trade unions and professional associations","5095":"Trade unions and professional associations","5099":"Transnational associations and networks of public regional or other sub-national authorities","5105":"Trade unions and professional associations","5110":"Trade unions and professional associations","5115":"Trade unions and professional associations","5130":"Trade unions and professional associations","5133":"Regional structures","5141":"Other public or mixed entities, created by law whose purpose is to act in the public interest","5157":"Transnational associations and networks of public regional or other sub-national authorities","5159":"Trade unions and professional associations","5171":"Trade unions and professional associations","5172":"Other public or mixed entities, created by law whose purpose is to act in the public interest","5197":"Regional structures","5205":"Trade unions and professional associations","5226":"Trade unions and professional associations","5227":"Trade unions and professional associations","5230":"Trade unions and professional associations","5256":"Trade unions and professional associations","5262":"Regional structures","5356":"Trade unions and professional associations","5371":"Trade unions and professional associations","5374":"Trade unions and professional associations","5390":"Regional structures","5400":"Trade unions and professional associations"};

  var event = ndx.dimension(function(d) {
    return d.id;    
  })
  var eventgroup   = event.group().reduceSum(function(d) {  return 1; });

  var count=dc.dataCount(".dc-data-count")
    .dimension(eventgroup)
    .group({value: function() {
            return eventgroup.all().filter(function(kv) { return kv.value>0; }).length;
      }});
    //.dimension(ndx)
    //.group(all);

  count.on("renderlet.resetall", function(c) {
      var total=c.dimension().size();
      var filtered= c.group().value();
      var disabled= (total == filtered);

      $(".resetall").attr("disabled",disabled);
      ga && ga('send', 'event', 'filter', 'subset', filtered);

      if (filtered >=0) {
        var one2one=0;
        eventgroup.all().forEach(function(d) { if(d.value ==1) one2one ++;});
        var ratio=Math.round(100-one2one/filtered*100);
        $(".one2one").html( ratio + "% collective meetings");
      }
  });

  dc.dataCount(".dc-data-count2")
    .dimension(ndx)
    .group(all);


  var name = ndx.dimension(function(d) {
      if (d.guest) {
          if (representatives[d.guestid])
            return d.title.toLowerCase()+" "+d.host.toLowerCase()+" "+d.guest.toLowerCase()+ " "+representatives[d.guestid].acronym.toLowerCase()+ " ";   
          else
            return d.title.toLowerCase()+" "+d.host.toLowerCase()+" "+d.guest.toLowerCase()+ " ";   

        }
        return d.title.toLowerCase()+" "+d.host.toLowerCase()+" "+d.unregistered.toLowerCase()+ " ";
          //+representative.[d.guestid];
      });

  drawTable();
  drawDate();
  drawWeekDay();
  drawHost();
  drawHostType();
  drawGuest();
  drawSector();
  drawMainCategory();
  drawCountry();
  drawExpense();
/*  drawScore();
  drawParty();
  drawRange();
*/

    function rotateBarChartLabels(chart) {
      chart.svg().selectAll('.axis.x text')
        .style("text-anchor", "end" )
        .attr("transform", function(d) { return "rotate(-45, -4, 9) "; });

    }


  function drawExpense () {
    var dim = ndx.dimension (function(d) {
      if (!representatives[d.guestid])
        return 0;
      return representatives[d.guestid].cost_absolute || representatives[d.guestid].cost_min;
  });

  var group   = dim.group().reduceSum(function(d) {   
      return 1; });

  var graph = dc.barChart (".expense")   
    .height(320)
    .width(530)
    .gap(0)
    .margins({top: 10, right: 20, bottom: 200, left: 40})
    .x(d3.scale.linear().domain([0, 100000]))
 //   .x(d3.scale.ordinal())
//    .xUnits(dc.units.ordinal)
    .elasticX(true)
    .elasticY(true)
        .brushOn(true)
    .yAxisLabel("Lobbying expense")
    .colorCalculator(function(d, i) {
        return "#f85631";
        })
    .dimension(dim)
    .group(group);

    graph.xAxis().ticks(5).tickFormat(d3.format(",.0f"));

    graph.yAxis().ticks(3).tickFormat(d3.format(",.0f"));
  }

  function drawCountry () {
  var dim = ndx.dimension (function(d) {
      if (!representatives[d.guestid])
        return "unknown";
      return representatives[d.guestid].contact_country;
  });

  var group   = dim.group().reduceSum(function(d) {   
        if (d.key == "108")
          return 0;
      return 1; });

  var graph = dc.barChart (".country")   
    .height(320)
    .width(530)
    .gap(0)
    .margins({top: 10, right: 20, bottom: 200, left: 40})
    .x(d3.scale.ordinal())
    .xUnits(dc.units.ordinal)
    .elasticX(true)
    .elasticY(true)
    .yAxisLabel("Number of Meetings")
    .colorCalculator(function(d, i) {
        return "#f85631";
        })
    .dimension(dim)
    .group(group)
    .on("postRender", function(c) {
        
        rotateBarChartLabels(c);} )
    .yAxis().ticks(4).tickFormat(d3.format(",.0f"));
  }

  
  function drawMainCategory () {
    function getName (d) {
      if (!d.guestid){
        if (d.unregistered == "")
          return [98,"Not mentioned"];

        return [99,"Not registered"];
      }
      if (!representatives[d.guestid])
        return [100,"Unknown"];
      return [representatives[d.guestid].main_category,mainCategories[representatives[d.guestid].main_category]];
    }

    var dim = ndx.dimension (function(d) {
        return getName(d);   
    });

    var group   = dim.group().reduceSum(function(d) {   return 1; });
    /*
       //return [representatives[d.guestid].main_category,representatives[d.guestid].main_category_title];
       var t={};
       group.all().forEach (function (d) {if (d.key[0]) t[d.key[0]]=d.key[1]})
       JSON.stringify(t);
    */

    var chart = dc.pieChart(".main_category")
      .innerRadius(10).radius(90)
      .height(200)
      .label(function(d){ return d.key[1] })
      .dimension(dim)
      .group(group);
  }

  function drawSector () {
  var dim = ndx.dimension (function(d) {
      if (!d.guestid){
        if (d.unregistered == "")
          return "Not mentioned";

        return "Not registered";
      }
      if (!representatives[d.guestid])
        return "Unknown";
      sub=representatives[d.guestid].sub_category;
      return [representatives[d.guestid].main_category,subCategories[sub]];
  });

  var group   = dim.group().reduceSum(function(d) {   return 1; });
    /*
       //return [representatives[d.guestid].main_category,representatives[d.guestid].main_category_title];
       var t={};
       group.all().forEach (function (d) {if (d.key[0]) t[d.key[0]]=d.key[1]})
       JSON.stringify(t);
    */

  var graph = dc.rowChart (".sector")   
    .height(500)
    .width(350)
    .gap(1)
    .margins({top: 0, right: 0, bottom: 0, left: 0})
    .x(d3.scale.ordinal())
    .label(function(d){
       if (typeof d.key == "string")
         return d.key;
       return d.key[1]; 
    })
    .elasticX(true)
    .colorCalculator(function(d, i) {
      if (d.key == "Not mentioned" || d.key == "Unknown" || d.key == "Not registered")
        return "lightblue";
      return "#f85631";
    })
    .dimension(dim)
    .group(group)
    .xAxis().ticks(4).tickFormat(d3.format(",.0f"));

  }


  function getPortfolio (d) {
    var host2portfolio = {
      "President Jean-Claude Juncker" : "Presidency",
      "Secretary-General Catherine Day": "Presidency",
  "Director-General Ann Mettler": "Presidency",

      "Director-General Robert Madelin":"Digital Economy",
  "Commissioner Günther Oettinger":"Digital Economy",
  "Director-General Stephen Quest":"Digital Economy",

  "Commissioner Miguel Arias Cañete":"Climate & Energy",
  "Director-General Dominique Ristori":"Climate & Energy",
  "Director-General Jos Delbeke": "Climate & Energy",

  "Commissioner Cecilia Malmström":"Trade",
  "Director-General Jean-Luc Demarty":"Trade",

  "Commissioner Jonathan Hill":"Financial Markets",
  "Director-General Jonathan Faull":"Financial Markets",

  "Commissioner Johannes Hahn":"Neighbourhood",
  "Director-General Christian Danielsson":"Neighbourhood",

      "Vice-President Jyrki Katainen" : "Jobs & Growth",

  "Commissioner Christos Stylianides":"Humanitarian Aid",

  "Commissioner Corina Crețu":"Regional Policy",
  "Director-General Walter Deffaa":"Regional Policy",

  "Commissioner Dimitris Avramopoulos":"Home Affairs",
  "Director-General Alfred Matthias Ruete":"Home Affairs",

  "First Vice-President Frans Timmermans":"Better Regulation",

  "Commissioner Phil Hogan":"Agriculture",
  "Director-General Jerzy Bogdan Plewa":"Agriculture",

  "Commissioner Violeta Bulc":"Transport",
  "Director-General Daniel Calleja Crespo":"Transport",
  "Director-General Joao Aguiar Machado":"Transport",

  "Vice-President Kristalina Georgieva": "Budget",
  "Director-General Nadia Maria Calvino Santamaria":"Budget",

  "Vice-President Andrus Ansip":"Digital Single Market",

  "Vice-President Maroš Šefčovič":"Energy Union",

  "Commissioner Elżbieta Bieńkowska": "Education",
  "Commissioner Tibor Navracsics":"Education",
  "Director-General Xavier Prats Monné": "Education",
  "Director-General Vladimir Šucha":"Education",

  "Commissioner Karmenu Vella":"Environment",
  "Director-General Lowri Evans":"Environment",
  "Director-General Karl-Friedrich Falkenberg":"Environment",

  "High Representative/Vice-President Federica Mogherini":"External Action",

  "Commissioner Vytenis Andriukaitis":"Health",
  "Director-General Ladislav Miko":"Health",

  "Director-General Fernando Frutuoso de Melo":"Development",
  "Commissioner Neven Mimica":"Development",

  "Vice-President Valdis Dombrovskis":"Euro",

  "Commissioner Pierre Moscovici":"Economics & Tax",
  "Director-General Heinz Zourek":"Economics & Tax",

  "Commissioner Věra Jourová":"Justice",
  "Director-General Paraskevi MICHOU":"Justice",

  "Commissioner Marianne Thyssen":"Employment",
  "Director-General Michel Servoz":"Employment",
  "Director-General Walter Radermacher":"Employment",

  "Director-General Robert-Jan Smits":"Research",
  "Commissioner Carlos Moedas":"Research",

  "Commissioner Margrethe Vestager":"Competition",
  "Director-General Alexander Italianer":"Competition",


    };

      if (d.cabinet) {
        return host2portfolio[d.cabinet.substr(19)] || d.cabinet.substr(19);//remove Cabinet member of...
        //return cabinet2Topic[d.cabinet] || d.cabinet.substr(19); //remove Cabinet member of...
      }
      return host2portfolio[d.host] || d.host;
  }

  function drawHostType () {
    function getType (d) {
      if (d.cabinet)
        return "Cabinet Members";
      if (d.host.indexOf ("Director-General") !== -1)
        return "Directors";
      if (d.host.indexOf ("President")  !== -1)
        return "Presidents";
      return "Commissioners"
    }

    var dim = ndx.dimension (function(d) {
        return getType(d);   
    });

    var group   = dim.group().reduceSum(function(d) {   return 1; });
    var chart = dc.pieChart(".hosttype")
      .innerRadius(10).radius(90)
      .height(200)
      .dimension(dim)
      .group(group);
  
  }

  function drawHost () {

  var dim = ndx.dimension (function(d) {
        return getPortfolio(d);

  });

  var group   = dim.group().reduceSum(function(d) {   return 1; });

  //var graph = dc.barChart (".host")   
  var graph = dc.rowChart (".host")   
    .margins({top: 0, right: 10, bottom: 20, left: 10})
    .height(520)
    .width(380)
    .gap(0)
    .x(d3.scale.ordinal())
    .elasticX(true)
    .colorCalculator(function(d, i) {
        return "#f85631";
        })
    .dimension(dim)
    .group(group);

    graph.xAxis().ticks(5).tickFormat(d3.format("d"));
    //.xAxis().ticks(4);

  }

  function drawGuest () {
    var dim = ndx.dimension (function(d) {
      if (!d.guest) {
        if (d.unregistered == "")
          return "Not mentioned";
        return "*"+d.unregistered;
      }
      return d.guest;
    });
    var group   = dim.group().reduceSum(function(d) {   return 1; });

    var filteredGroup = (function (source_group) {return {
        all:function () {
            return source_group.top(10).filter(function(d) {
                return (d.key != "Not mentioned" && d.value !=0) ;
            });
        }
    };})(group);
    var graph = dc.rowChart (".guest")   
      .margins({top: 0, right: 10, bottom: 20, left: 10})
      .height(300)
      .width(200)
      .gap(0)
      .x(d3.scale.ordinal())
      .elasticX(true)
      .colorCalculator(function(d, i) {
          return "#f85631";
          })
    .ordering(function(d){return -d.value})
      .dimension(dim)
      .group(filteredGroup);
    graph.xAxis().ticks(5).tickFormat(d3.format("d"));

    var count=dc.dataCount(".org-count")
      .dimension(group)
      .group({value: function() {
          return group.all().filter(function(kv) { return kv.value>0; }).length;
      }});

  };

  function drawTable () {
    var i=0;
    wall=dc.dataTable(".dc-data-grid")
     .dimension(name)
      .group(function (d) { return "";return d.country; })
      .columns([
          function(d) { i=i+1; return i; },
          function(d) {  return d.host; },
          function(d) {  return getPortfolio(d); },
          function(d) {
              if (d.date == null) return "canceled";
              return d.date.getDate()+"/"+(1+d.date.getMonth())+"/"+d.date.getFullYear();
          },
          function(d) {  return d.title; },
          function(d) {  
          if (!d.guestid) {
            return "<span class='unregistered'>"+d.unregistered+"</span>";
          }
          if (representatives[d.guestid] && representatives[d.guestid].acronym )
          return "<span title='"+d.cost_absolute+"'>"+d.guest + " ("+representatives[d.guestid].acronym +")</span>";
          return d.guest;
          },
      ])
    .size(100)
    .sortBy(function (d) {return -d.date})
    .renderlet(function (chart) {
      i = 0;
      $(".dc-table-group").remove();
      $("td:first-child").each (function(i) { 
        $(this).closest ("td").css("backgroundColor", 
          $(this).css('backgroundColor')
        );
      });
      $("td span.score").each (function(i) { 
        $(this).closest ("td").css("backgroundColor", 
          $(this).css('backgroundColor')
        );
      });
      $("table.dc-data-grid").trigger("update");
    });
  }

    dc.renderAll();
    hashFilter();

     $("table.dc-data-grid").tablesorter(
        {theme:"bootstrap",headers: {}}
     ).bind("sortEnd",function(e, table) {
      ga && ga('send', 'event', 'sort','table');
      var i=0;
      $("td:first-child").each (function(){this.innerHTML=++i;});
    });

function drawRange () {
	
	/*colors
	"#ffffff",
	"#f8e8e5",
	"#f9d1c8",
	"#f9a896",
	"#fb8065",
	"#f85631"
	*/
 
  function getRange (d) {
    if (d.score === 0 ) return ". None"; 
    if (d.min < 500 ) return "0. < 500"; 
    if (d.min < 1001 ) return "1. < 1000"; 
    if (d.min < 5001 ) return "2. < 5000"; 
    if (d.min < 10001 ) return "3. < 10000"; 
    return "4. 10000 or more";
  };

  var color = d3.scale.ordinal()
  	  //blue->orange//.range(["#3695d8", "#5989b3", "#857c93", "#ae6e74", "#d76155", "#ff523a"]);
      .range(["#FFFFFF", "#8ed3fb", "#68add4", "#4388ad", "#1a6287", "#003c60"]);
        
  var dimension = ndx.dimension(function(d) {
    return getRange(d);
  });

  var group   = dimension.group().reduceSum(function(d) { return 1; });
  var chart = dc.pieChart(selector +  " .range")
    .innerRadius(50).radius(100)
    .height(200)
    .colors(color)
    .colorAccessor(function (d, i){return i;})
    .dimension(dimension)
    .group(group);
}

function drawParty () {
  var bubble_party = dc.bubbleChart(" .party");
  var party = ndx.dimension(function(d) {
      if (typeof d.party == "undefined") return "";
      return d.party;
      });
   var tip = d3.tip()
    .attr('class', 'd3-tip')
    .html(function(p) { return '<span><h2>' +
        p.key + "</h2><ul>" + 
                "<li>Number of events: " +p.value.count + "</li>" +
                "<li>Averdate participation: " +Math.floor (p.value.effort/p.value.count) + "</li>" +
                "<li>Averdate score: "+Math.floor (p.value.score/p.value.count); 
       '</li></ul></span>' })
    .offset([-12, 0])


  var partyGroup   = party.group().reduce(
      function(a,d) {a.eugroup = d.eugroup;a.count +=1; a.score +=d.score; a.effort += d.attendance.score; return a; },
      function(a,d) {a.eugroup = d.eugroup;a.count -=1; a.score -=d.score; a.effort -= d.attendance.score; return a; },
      function() {return {eurgroup:0,count:0,score:0,effort:0}; }
      )
      .order(function (p) {return p.count});
  bubble_party
    .colorCalculator(function(d, i) {
      return eu_groups[d.value.eugroup];
    })
  .valueAccessor (
      function(d) {
      return d.value.count;
      })
  .width(660)
    .height(300)
    .margins({top: 20, right: 20, bottom: 20, left: 30})
    .yAxisLabel("%Votes attended")
    .dimension(party)
    .group(partyGroup)
    .keyAccessor(function (p) {
        return p.value.score/p.value.count;
    })
    .valueAccessor(function (p) {
        return p.value.effort/p.value.count;
    })
    .radiusValueAccessor(function (p) {
        return p.value.count;
    })
    .x(d3.scale.linear().domain([0, 60]))
    .r(d3.scale.linear().domain([0, 100]))
    .minRadiusWithLabel(150)
}

function drawDate() {
  var chart_date = dc.lineChart(".date");

 var date = ndx.dimension(function(d) {
      if (typeof d.date == "undefined") return "";
      return d.date;
      });

//minDate = date.bottom(1)[0].key;
//maxDate = date.top(1)[0].key;

  var dateGroup   = date.group().reduceSum(function(d) {   return 1; });

  chart_date
    .height(200)
    .width (430)
    .margins({top: 0, right: 20, bottom: 20, left: 30})
        .round(d3.time.month.round)
        .xUnits(d3.time.months)
        .x(d3.time.scale().domain([new Date(2014, 11, 1), new Date(2015, 06, 1)]))

    .brushOn(true)
    .renderArea(true)
    .elasticY(true)
    .yAxisLabel("Number of meetings")
    .dimension(date)
    .group(dateGroup);
}

function drawWeekDay() {
    var graph=dc.rowChart('.day-of-week-chart');
    // counts per weekday
    var dayOfWeek = ndx.dimension(function (d) {
        if (d.date == null) return "Unknown";
        var day = d.date.getDay();
        var name = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        return day + '.' + name[day];
    });
    var dayOfWeekGroup = dayOfWeek.group();

    
    graph.width(180)
        .height(180)
        .margins({top: 20, left: 10, right: 10, bottom: 20})
        .group(dayOfWeekGroup)
        .dimension(dayOfWeek)
        // assign colors to each value in the x scale domain
        .ordinalColors(['#3182bd', '#6baed6', '#9ecae1', '#c6dbef', '#dadaeb'])
        .label(function (d) {
            return d.key.split('.')[1];
        })
        // title sets the row text
        .title(function (d) {
            return d.value;
        })
        .elasticX(true)
        .xAxis().ticks(4);

}

function drawScore() {

  var host2Topic = {};

  var dim = ndx.dimension (function(d) {
      if (d.cabinet) {
        return cabinet2Topic[d.cabinet] | d.cabinet;
      }
      return host2Topic[d.host] | d.host;
  });

  var group   = dim.group().reduceSum(function(d) {   return 1; });

  var graph = dc.barChart (".bar_score")   
    .height(220)
    .width(330)
    .gap(0)
    .margins({top: 10, right: 20, bottom: 20, left: 40})
    .x(d3.scale.linear().domain([0, 70]))
    .elasticX(true)
    .elasticY(true)
    .yAxisLabel("Number of events")
    .round(dc.round.floor)
    .colorCalculator(function(d, i) {
        return "#f85631";
        })
    .valueAccessor (
      function(d) {
      return d.value.count;
      })
    .dimension(dim)
    .group(group)
    .renderlet(function (chart) {
//      var d = chart.group().top(Number.POSITIVE_INFINITY);
      var total = nb = min = max = 0;
      var d = chart.dimension().top(Number.POSITIVE_INFINITY);
      d.forEach (function (a) {
        if (isNaN(a.score)) return;
        ++nb;
        total += a.score;
        min += a.min;
        max += a.max;
      });
      if (nb) {
        var avg= total/nb;
        $("div#avg_score").text(Math.round(avg));
        $("div#sum_side").html("Total "+ Math.round(min)+" &euro;");
        $("div#avg_side").html("Averdate "+Math.round(min/nb)+ " &euro;");
      } else {
        $("div#avg_score").text("");
      }
      //why doesn't it work? if (chart.dimension().size() !== chart.group().value()) {}
      if (ndx.size() !== nb) {
        $(".resetall").attr("disabled",false);
        ga && ga('send', 'event', 'filter', 'subset', nb);
      } else {
        $(".resetall").attr("disabled",true);
        ga && ga('send', 'event', 'filter', 'reset');
      }

  });
  bar_score.yAxis().ticks(4).tickFormat(d3.format(",.0f"));
}


}

  function getAmountString(d) {
          if (d.qty == 0) {
            return "";
          }
          if (d.max == Number.POSITIVE_INFINITY)
            return "<span class='q"+d.qty+"' title='"+d.qty.length+" different occupations'>"+d.min+" &euro; or more</span>";
          return d.min +" &#8605; "+d.max +"  &euro;";
  }

  function getAmount (category, field) { //field = min (default) or max or "string"
    field = field || "min";
    if (!category) return "?";
    if (isNaN(category)) return category;
    if (category < 0 && field == "min") return "0";
    if (category < 0 && field == "max") return "499";
    if (category < 0 && field == "string") return "0  &#8605; 499 &euro;";
     
    if (category >=4 && field == "max") return "or more";
    if (category >=4 && field == "string") return rangeEUR[category]["min"] + " or more";
    if (field == "string")
      return  rangeEUR[category]["min"] + " &#8605; "+  rangeEUR[category]["max"];
    return rangeEUR[category][field];
  }

function hashFilter () {
  var hash = window.location.hash;

   if(hash.indexOf('#mep') === 0) { 
     eventpopup(hash.substring(4));
     ga && ga('send', 'event', 'urlevent',hash.substring(4));
   }
}
   
function eventpopup (epid) {
      window.location.hash = "event"+d.epid;
       ga && ga('send', 'event', 'clickevent',hash.substring(4));
      //$( "#twitter").html(tplTwitter(d));

}

</script>


<nav class="navbar navbar-default" role="navigation">
	<div class="container">
    	<div class="navbar-header">
      		<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        		<span class="sr-only">Toggle navigation</span>
        		<span class="icon-bar"></span>
        		<span class="icon-bar"></span>
        		<span class="icon-bar"></span>
      		</button>
	      	<div class="navbar-brand" id="ti_logo">
	      		<a href="http://www.transparencyinternational.eu">Transparency International</a>
	     	</div>
	    </div>
    
    	<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
	    	<ul class="nav navbar-nav" id="title_container">
	    	    <li><a id="pdate_title" href="/" target="_blank"><strong>EU</strong> Integrity Watch</a></li>
	    	</ul>
	        <ul class="nav navbar-nav navbar-right">
	            <li><a href="about.html">About</a></li>
	            <li><a href="contact.html">Contact</a></li>
	    	</ul>
    	</div>
   </div><!-- container -->
</nav>

<div class="container_wrap" id="about_wrap">
	<div class="container">
		<div id="about_container" class="row">
			<div class="col-md-9" id="about_content">
				<p>
EU Integrity Watch is a user-friendly interactive database that provides a unique overview of the activities of the commissionners and cabinet members in the European Commission.members of the European Parliament. By simply clicking on the graphs or the list below users can rank, sort and filter events.
<br/>
				<a href="about.html" class="more">Read more</a>
				</p>
			</div>
			<div class="col-md-3" id="about_social">

<br/>
<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-via="TI_EU" data-text="Want to know #events income & activities outside @Europarl_EN? Find out">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
<br/>
<br/>
<div class="fb-like" data-show-faces="false"  data-href="http://www.integritywatch.eu/" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div>

 <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>

</p>
-->
      </div>
		</div>
		
	</div><!-- container -->
</div>
<div class="container_wrap" id="toggle_about_wrap">
	<div class="container">
		<div class="row">
			<div class="col-xs-2 col-md-1 col-centered" id="collapse_about">
				<a class="opened" href="#">collapse</a>
			</div>
		</div>
	</div>
</div>

<div class="container_wrap" id="filter_wrap">
	<div class="container">
		<div class="row">
			<div class="col-sm-7" id="filter_field_container">
			 	<p>Filter the results by selecting a range in the charts,
			 	or by filling the filter box:</p>
			 	<div class="input-group">
			 	    <input type="text" id="search-input" class="form-control input-lg" placeholder="filter by meeting name or organisation...">
			 	</div>
			 	<button class="btn resetall">RESET ALL FILTERS</button>
			</div>
			<div class="col-sm-3 col-md-3 no-col-md-offset-1" id="filter_mep_number">
				<p>You have currently selected</p>
				<div id="mep_number" class="dc-data-count">
					<span id="abig_number" class="filter-count"></span>/<span class="total-count"></span> events
				</div>
				<div id="org_number" class="org-count">
					<span class="filter-count"></span>/<span class="total-count"></span> organisations
				</div>
			</div>
			<div class="col-sm-2">
        <div></div>
        <div class="one2one"></div>
        <div class="civilsociety">x% civil society?</div>
      </div>

		</div>
	</div>
</div>

<div id="ec">
	<div class="container_wrap" id="main_charts_wrap">
		<div class="container">
			<h2>Charts</h2>
			<div class="row">
				<div class="col-md-5 chart_box">
					<h3>Host<!--span class="info">info</span--></h3>
					<div class="hosttype"></div>
					<h4>Portfolio<!--span class="info">info</span--></h4>
					<div class="host"></div>
					<br class="clear" />
				</div>
				<div class="col-md-3 chart_box" id="group_container">
					<h3>Top organisations<!--span class="info">info</span--></h3>
            <div class="guest"></div>
					<h3>Day of weeks <!--span class="info">info</span--></h3>
					<div class="day-of-week-chart">
					</div>
					<br class="clear" />
				</div>
				<div class="col-md-4 chart_box">
					<h3>Category of Lobby organisation</h3>
          <div class="main_category"></div>
					<h4>Sector of Lobby organisation</h4>
					<div class="sector range">
					</div>
					
					<br class="clear" />
				</div>
			</div>
			<a href="#" id="view_charts" class="hiddencharts">VIEW ALL THE CHARTS</a>
		</div>
		
	</div>
	
	<div class="container_wrap" id="ihidden_charts_wrap">
		<div class="container">
				
			<div class="row">
				<div class="col-md-7 chart_box">
					<h3>Lobbying expense</h3>
					
					<div class="expense">
					</div>
					
				</div>
			</div>
		</div>
			<div class="row">
				<div class="col-md-7 chart_box">
					<h3>Country</h3>
					
					<div class="country">
					</div>
					
					<br class="clear" />
				</div>
				<div class="col-md-5 chart_box">
					<h3>Date</h3>
					<div class="date">
					</div>
					<br class="clear" />
				</div>
			</div>
		</div>
	</div>
</div>


<div class="container_wrap" id="list_container">
	<div class="container">
		<div class="row">
			<div class="content" id="list_content">
				<h2>Latest 100 meetings in the commission</h2>
				<div class="info_chart" id="attendance_info">
					<span class="info">info</span>
					<p class="desc">Events</p>
				</div>
				
				<div class="info_chart" id="EAI_info">
					<span class="info">info</span>
					<p class="desc">The External Activity Indicator was developed by Transparency International EU to provide a quick overview of all outside activities of members of the European Parliament. In short, the higher the indicator the higher the outside income and number of outside activities of a member. A higher EAI is reflected in a darker shading of orange. <br /><a href="about.html#methodology">More details</a></p>
				</div>
				
				<div class="info_chart" id="OI_info">
					<span class="info">info</span>
					<p class="desc">Total monthly income declared by the member in the Declaration of Financial Interests</p>
				</div>
			</div>
			
			<div class="col-md-12 table-responsive">
				<table class="table table-hover dc-data-grid tablesorter-bootstrap">
					<thead>
						<tr class=header>
							<th class="headerSortDown">Nr</th> 
							<th>Name</th> 
							<th>Portfolio</th> 
							<th>date</th> 
              <th>Subject</th> 
							<th>With</th> 
						</tr>
					</thead>
				</table>
			</div>
		</div>
		
		<div id="last_update">Last updated: 11 May 2015</div>
	</div>
</div>

<script>
'use strict';
  var events=[];
  var representatives={};
  $(function() {
    var renderLoaded  = _.after(2,  function () { 
      //var dateFormat = d3.time.format("%d/%m/%Y");
      var dateFormat = d3.time.format("%Y-%m-%d");
      var now = Date.now();
      var a;

      _.each (events, function (d) {
        d.date=dateFormat.parse(d.date);
        if (!d.cabinet) 
          return;
        if (d.cabinet.substr(19)=="Cabinet member of ")
          d.cabinet = d.cabinet.substr(19);
      });
      grid ("#ec",events);
    });
    d3.csv("data/meeting.csv", function(d) {return d;}
      ,function(error, rows) {
         events = rows;
         renderLoaded();
      });      
    //d3.json("data/representative-light.json", function (rows) {
    //d3.csv("data/representative.csv", function (rows) {
    d3.csv("data/representative-finance-light.csv", function (rows) {
         _.each (rows, function (d) {
            //representatives[d.identification_code]=d;
            representatives[d.id]=d;
      });
         renderLoaded();
    });     

  $("#search-input").keyup (function () {
    var s = $(this ).val().toLowerCase();
    wall.dimension().filter(function (d) { 
      return d.indexOf (s) !== -1;} );
    $(".resetall").attr("disabled",false);
    dc.redrawAll();
  });

  $(".resetall").click(function() {
    $("#search-input").val("");
    $(".resetall").attr("disabled",true);
    dc.filterAll();
    dc.renderAll();

  });

 
});      

</script>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-55613514-1', 'auto');
  ga('send', 'pdateview');

</script>
</body>
</html>
