<html lang="en" dir="ltr">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="twitter:card" content="summary" />
	<meta name="twitter:site" content="@TI_EU" />
	<meta name="twitter:creator" content="@eucampaign" />
	<meta property="og:url" content="http://www.integritywatch.eu" />
	<meta property="og:title" content="EU Integrity Watch: monitor potential conflicts of interests" />
	<meta property="og:description" content="Who’s #lobbying the EU Commission and how much are they spending? Check Integrity Watch" />
	<meta property="og:image" content="http://www.integritywatch.eu/img/thumbnail.jpg" />
	<meta property="fb:app_id" content="1611680135716224" />
	<title>Integrity Watch Chile</title>
	<link rel="shortcut icon" href="favicon.ico">
	<link href="css/bower.min.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="css/dc.css"/>
	<link rel="stylesheet" type="text/css" href="css/style.css"/>
	<script type="text/javascript" src="js/bower.js"></script>
	
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the pdate via file:// -->
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->

	<style>
		td.dc-table-column._4,
		td.dc-table-column._5,
		td.dc-table-column._6
		{text-align:left;}

		#mep_number {
				margin-top: 0.1em;}
		.l_data_container {
			padding: 10px 15px;
			margin: -10px;
			background: #d4eaf6;
		}
		.l_data_container div {
			border: none;
			margin-top: 0;
			padding-bottom: 0;
			margin: 5px 0 5px 0;
		}
		.l_data_container_main {
			background: #d4eaf6;
			margin-bottom: 20 !important;
			font-size: 18px;
			text-align: center;
		}
		.l_data_container label {
			font-weight: 600;
		}
		.l_data_container_main label {
			color: #333;
		}
		.l_data_container_host {
			border: 4px solid #0f4c79 !important;
			border-right: 3px solid #0f4c79 !important;
			margin-top: 0 !important;
			//height: 230px;
			padding: 10px 15px !important;
			background: #fff;
		}
		.l_data_container_guest {
			border: 4px solid #8e1556 !important;
			border-left: 3px solid #8e1556 !important;
			margin-top: 0 !important;
			//height: 230px;
			padding: 10px 15px !important;
			background: #fff;
		}
		.l_data_container_guest label, .l_data_container_guest .data_container_title {
			color: #8e1556 !important;
		}
		.l_data_container_host label, .l_data_container_host .data_container_title {
			color: #0f4c79 !important;
		}
		.data_container_title {
			font-size: 15px;
			font-weight: 800;
			text-transform: uppercase;
			
		}
		.legend div.individual::before {
			background: #af0700 none repeat scroll 0 0;
		}
		.legend div.tradeunion::before {
			background: #f6b862 none repeat scroll 0 0;
		}
		.legend div.companies::before {
			background: #fcb000 none repeat scroll 0 0;
		}
		.otro::before {
			background: #bbb;
		}
		.main_category svg, .hosttype svg, .categoria svg {
			overflow: visible !important;
		}
		.navbar .navbar-nav > li > a {
			width: 160px;
		}
		#filter_wrap #currently_selected_text {
			width: 150px;
		}
		.dectype text.pie-slice, .topprofessions text.pie-slice {
			display: none !important;
		}
		.filter_btn_container {
			padding: 40px 0 20px 0;
		}
		.salario-box-1 {
			border: 2px solid #5b9bd5 !important;
			padding: 10px 20px !important;
			text-align: center;
		}
		.salario-box-2 {
			border: 2px solid #f68d47 !important;
			padding: 10px 20px !important;
			text-align: center;
		}
		.infobox-divider {
			height: 2px;
			background: #5b9bd5;
		}
		/*
		#candidates_btn {
			width: 110px;
			padding: 15px 10px;
			background: #fff;
			border: 2px solid #0f69b4;
			color: #0f69b4;
			vertical-align: middle;
			font-weight: 700;
			font-size: 11px;
			text-transform: uppercase;
		}
		#candidates_btn.unactive {
			color: #666;
			background: #eee;
			border: 2px solid #eee;
		}
		*/
		#gobierno_btn, #diputados_btn, #senado_btn, #candidates_btn {
			height: 80px;
			vertical-align: middle;
			margin-right: 10px;
		}
		.moregraphs {
			border-bottom: 1px solid #0f69b4;
			font-family: "Helvetica W02 Bd Cn","HelveticaNeue-Light","Helvetica Neue Light","Helvetica Neue",Helvetica,Arial,"Lucida Grande",sans-serif;
			color: #0f69b4;
			font-size: 20px;
			text-align: center;
			padding: 10px;
			margin-bottom: 30px;
			margin-top: 30px;
			cursor: pointer;
		}
		div#ti_logo_container a#ti_logo {
			background-image: url("./img/logo_TI-Chile-white.png");
			height: 60px;
			width: 56%;
		}
		.navbar .navbar-nav > li > a {
			width: 130px;
			padding-top: 12px;
			padding-bottom: 12px;
		}
		.topprofessions .dc-legend-item {
		    overflow: hidden;
		}
		.infofix {
			position: relative;
		}
		.infofix .info_chart {
			top: -40px;
			right: 0;
		}
		.chart_box h3 {
			text-transform: capitalize;
		}
		.nav li#cm_tool_btn.active a {
			background: #039aab none repeat scroll 0 0;
			color: #fff;
		}
		#filter_wrap.filter_cm {
			 background: #039aab none repeat scroll 0 0;
		}
	</style>
</head>

<body>

<script>
	//Additional date sorting for datatables
	var dmy = d3.time.format("%d/%m/%Y");
	jQuery.extend( jQuery.fn.dataTableExt.oSort, {
		"date-eu-pre": function ( date ) {
					return dmy.parse(date);
		},
		"date-eu-asc": function ( a, b ) {
			return ((a < b) ? -1 : ((a > b) ? 1 : 0));
		},
		"date-eu-desc": function ( a, b ) {
			return ((a < b) ? 1 : ((a > b) ? -1 : 0));
		}
	} );
	//Doc ready
	$( document ).ready(function() {
		$('#view_charts').click(function(ev) {
			ev.preventDefault();
			$('#hidden_charts_wrap').slideToggle('slow', function () {
				changeLinkStatus();
			})
		})
		function changeLinkStatus() {
			if($('#hidden_charts_wrap').css('display') == 'none'){
				$('#view_charts').text('VIEW ALL THE CHARTS')
			}else {
				$('#view_charts').text('HIDE CHARTS')
			}
			$('#view_charts').toggleClass('hiddencharts');
		}
		$('#collapse_about a').click(function(ev) {
			ev.preventDefault();
			$('#collapse_about a').toggleClass('opened');
			$('#collapse_about a').toggleClass('closed');
			$('#about_wrap').slideToggle('slow', function () {
				$('#about_wrap_top').slideToggle('fast')
			})	
		})
		$('.info').click(function(ev) {
			ev.preventDefault();
			if($(this).hasClass('opened')){
				$(this).removeClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideUp('fast')
			}else{
				closeAllInfos();
				$(this).addClass('opened');
				$(this).parents('.info_chart').find('p.desc').slideDown('fast')
			}
		});
		function closeAllInfos() {
			$('.info').removeClass('opened');
			$('p.desc').slideUp('fast');
		}
	});
	//End doc ready

	//Main vars for modal panels
	var detailtpl = sidetpl = null ;
	var wall = null;

	//Grid function (generates graphs and counts)
	function grid (selector,data) {
		
		var ndx = crossfilter(data),
				all = ndx.groupAll();

		var color = d3.scale.linear()
					.clamp(true)
					.domain([0,1, 70])
					.range(["white","#ffc7b6", "#f85631"])
					.interpolate(d3.interpolateHcl);

		evt = ndx.dimension(function(d) {
			return d.Id_Declaracion;		
		})

		var count = dc.dataCount(".dc-data-count")
			.dimension(ndx)
			.group(all);
			
		count.on("renderlet.resetall", function(c) {
		  RefreshTable();
		});

		nameEvent = ndx.dimension(function(d) {
			return d.fullName.toLowerCase() + " cargo:" + d.Cargo.toLowerCase() + " id:" + d.Id_Declaracion;
		});

		//Draw graphs
		drawTable();
		drawDecType();
		drawActivities();
		drawActivitiesPro();
		drawVehicles();
		drawInmuebles();
		drawAcciones();
		drawAccionesVal();
		drawTotVal();
		drawProfessions();
		drawIncome();

		function rotateBarChartLabels(chart) {
			chart.svg().selectAll('.axis.x text')
				.style("text-anchor", "end" )
				.attr("transform", function(d) { return "rotate(-45, -4, 9) "; });

		}
		function setword(wd) {
			$("#search-input").val(wd);
			var s = wd.toLowerCase();
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
					console.log ("redraw");
						dc.redrawAll();
				}, 250);
			}
		}

		//WordCloud Chart
		function drawCloud() {
			 var dim = ndx.dimension(function(d) {
			  return d.observacionesMateriaAudiencia || "";
			 })
			 var group   = dim.group().reduceSum(function(d) { return 1; });
			 var graph =  dc.wordCloud(".wordcloud")
			  .rotate(function() { return ~~(Math.random() * 2) * 90; })
			  .size([320,380])
			  .dimension(dim)
			  .maxWords(50)
			  .padding(5)
			  .ordinalColors(['#133d82', '#2163ad', '#3893d1', '#84c0e8', '#cfecff'])
			  .group(group)
			  .scale(d3.scale.linear().domain([10,100]).range([6, 30]))
			  .textAccessor(function(d) {return d.observacionesMateriaAudiencia;})
			  .onClick(function(d){setword(d.key);})
			  .stopWords (/^(está|grupo|entre|n°|conocer|sector|plan|posición|Informar|9729|marco|lógicas|Nueva|ley|Actos|millas|código|Idi|actual|ex|entrega|Modifica|21|crea|DFL|carrera|término|respecto|dado|Atención|Obcervaciones|2016|uso|requieren|continuidad|manera|posibles|podrían|entrega|Dar|país|alternativa|condiciones|comentarios|horas|julio|actualmente|impacto|busca|moderniza|Fortalece|OTRAS|grabadas|audiancia|atención|preocupación|situación|tema|algunos|sistema|9936|Proyecto|7606|acuerdo|acuerdos|centralizado|1100|22|mayo|Lunes|asesor|previo|Operadores|moción|parlamentaria|normas|Consultas|Fija|acción|REINTEGRO|Finalmente|proyecto|presentación|empresa|hacer|encuentro|red|presente|Minsterio|DS|respecto|seremi|Intendente|Comuna|Ley|Audiencia|Web|Apoyo|Construye|Inmobiliaria|2016201|ha|changes|categoria|65892690k|fecha|características|•|compromiso|matriz|idea|temática|RUT|–|em|tiene|suponia|Estaciones|dia|ha|proceso|señala|todas|Rojas|reunión|1000|nuevo|19|aspectos|ceremonial|they|operación|consulta|semana|SEC|oferta|conocer|PERCEPCIONES|INFORME|Solicita|pago|Generales|actual|fruto|generados|involucraría|contribuyendo|regional|Solicitud|desea|abordar|adquiro|temas|está|2015|Agenda|Prioridades|hitos|tabla|SerenaVarasSe|Ubicada|Pronunciamiento|Extraordinarias|Reparación|Obra|obras|V°B°|Villa|Servidas|2292002|Politica|zona|central|Productivo|SA|entre|tres|uso|4|19|o|avance|Nuevo|Región|Poder|son|acuerdo|medidas|correctivas|PortalesTemas|cómo|Ampliación|montos|pago|Octubre|encuentran|modificación|ciudad|1|N°2|gestión|salvaguardar|Mediante|estructural|Tratar1|plazo|Juego|Presentar|NOSOTROS|playa|Fallo|han|mesa|denegación|bis|Art|Sostiene|importancia|través|objetivo|todos|qué|Animas|nos|2|esta|como|N°|0|3|Sr|una|más|lo|es|este|sus|e|ya|el|del|que|las|los|al|un|su|para|por|se|con|sobre|y|i|me|my|myself|we|us|our|ours|ourselves|you|your|yours|yourself|yourselves|he|him|his|himself|she|her|hers|herself|it|its|itself|they|them|their|theirs|themselves|what|which|who|whom|whose|this|that|these|those|am|is|are|was|were|be|been|being|have|has|had|having|do|does|did|doing|will|would|should|can|could|ought|i'm|you're|he's|she's|it's|we're|they're|i've|you've|we've|they've|i'd|you'd|he'd|she'd|we'd|they'd|i'll|you'll|he'll|she'll|we'll|they'll|isn't|aren't|wasn't|weren't|hasn't|haven't|hadn't|doesn't|don't|didn't|won't|wouldn't|shan't|shouldn't|can't|cannot|couldn't|mustn't|let's|that's|who's|what's|here's|there's|when's|where's|why's|how's|a|an|the|and|but|if|or|because|as|until|while|of|at|by|for|with|about|against|between|into|through|during|before|after|above|below|to|from|up|upon|down|in|out|on|off|over|under|again|further|then|once|here|there|when|where|why|how|all|any|both|each|few|more|most|other|some|such|no|nor|not|only|own|same|so|than|too|very|say|says|said|shall|la|du|mr|commissioner|et|des|dg|commission|de|pour|en|les|le|meeting|eu|new|priorities|presentation|preparation|issues|meetings|representatives|work|implementation|general|future|challenge|challenge|skey|role|exchange|views|discuss|discussion|various director|talks|position|global|field|level|initiative|company|state|aspects|context|current|change|european|potential|including|dans|within|developments|play|present|Päris|Enegry|deep|Susan|Danger|Managing|Director|AmCham|Karl|Cox|Vice|President|Oracle| Bert|Boers|SAS|Marco|Comastri|EMEA|CA|Patrick|Deconinck|Senior|Western|3M|Harry|van| Dorenmalen|Chairman|IBM|Aongus|Hegarty|Dell|Cindy|Miller|UPS|Christian|Morales|Manager|Intel| |Julián|Nebreda|AES|Peter|Ryan|VP|HP|Nigel|Lewis|Caterpillar|Dirk|Ostijn|Head|&| Chief|Executive |Officer|MetLife|CA|flagship|related|portfolio|Cssr|Jourova|(| voting|all|expats|as|part|)|,|Year)$/);

		}
		
		function activitiesRange(num){
			/*
			if(num >= 1 && num < 5){
				return "1 - 4";
			}
			if(num >= 5){
				return "5 +";
			}
			return "0";
			*/
			if(num > 5){
				return "5+";
			}
			return num;
		}
		
		//Type
		function drawDecType() {
			var dim = ndx.dimension (function(d) {
					return d.Tipo;   
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });
			/*
			var typecolor = {			
				"0":"#8da9db",
				"1 - 4":"#a8d08c",
				"5 +":"#f4b081"
			};
			*/
			var chart = dc.pieChart(".dectype")
				.innerRadius(90).radius(130)
				//.margins({top: 0, right: 3, bottom: 20, left: 3})
				.cy(150)
				.height(440)
				.dimension(dim)
				.cap(7)
				.group(group)	
				/*				
				.colorCalculator(function(d, i) {
					return typecolor[d.key];
				});
				*/
				chart.legend(dc.legend().x(30).y(320).itemHeight(13).gap(5))
		}
		
		//Activities
		function drawActivities () {
			var dim = ndx.dimension (function(d) {
					return activitiesRange(d.activity.length);   
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });
			var typecolor = {			
				"0":"#8da9db",
				"1 - 4":"#a8d08c",
				"5 +":"#f4b081"
			};
			var chart = dc.pieChart(".nactividades")
				.innerRadius(0).radius(100)
				.height(280)
				.dimension(dim)
				.cy(110)
				.cap(7)
				.group(group)	
				/*
				.colorCalculator(function(d, i) {
					return typecolor[d.key];
				});
				*/
				chart.legend(dc.legend().x(65).y(235).itemHeight(13).gap(5).horizontal(true).itemWidth(40))
		}
		
		//Professional Activities
		function drawActivitiesPro () {
			var dim = ndx.dimension (function(d) {
					return activitiesRange(d.activityPro.length);   
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });
			var typecolor = {			
				"0":"#8da9db",
				"1 - 4":"#a8d08c",
				"5 +":"#f4b081"
			};
			var chart = dc.pieChart(".nproactividades")
				.innerRadius(0).radius(100)
				.height(280)
				.dimension(dim)
				.cy(110)
				.cap(7)
				.group(group)	
				/*
				.colorCalculator(function(d, i) {
					return typecolor[d.key];
				});
				*/
				chart.legend(dc.legend().x(65).y(235).itemHeight(13).gap(5).horizontal(true).itemWidth(40))
		}
		
		//Category Chart (Lobbyist or gestores de intereses)
		function drawCategoria() {
			var dim = ndx.dimension (function(d) {
					return d.categoriaA;   
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });
			var hosttypecolor = {			
				"Lobbyistas":"#5b9bd5",
				"Gestores de intereses":"#ed7d31",
				"Unknown":"#bbbbbb"
			};
			var chart = dc.pieChart(".categoria")
				.innerRadius(70).radius(100)
				.height(250)
				.dimension(dim)
				.cap(7)
				.group(group)
				//.legend(dc.legend().x(0).y(190).gap(10)) TODO: use dc.legend		
				.colorCalculator(function(d, i) {
					return hosttypecolor[d.key];
				});
				chart.legend(dc.legend().x(30).y(240).itemHeight(13).gap(5))
		}
		
		function bienesRange(num){
			if(num >= 5){
				return "5+";
			}
			return num.toString();
		}

		//Vehicles
		function drawVehicles () {
			var dim = ndx.dimension (function(d) {
				return bienesRange(d.mueble.length);
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var graph = dc.barChart(".vehicles")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(270)
				//.width(165)
				.gap(8)
				.x(d3.scale.ordinal().domain(["0", "1", "2", "3", "4", "5+"]))
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
				
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
		};
		
		//Acciones
		function drawAcciones () {
			var dim = ndx.dimension (function(d) {
				return bienesRange(d.acciones.length);
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var graph = dc.barChart(".empresas")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(270)
				//.width(165)
				.gap(8)
				.x(d3.scale.ordinal().domain(["0", "1", "2", "3", "4", "5+"]))
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
				
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
		};
		
		//Inmuebles
		function drawInmuebles () {
			var dim = ndx.dimension (function(d) {
				return bienesRange(d.inmueble.length);
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var graph = dc.barChart(".inmuebles")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(270)
				//.width(165)
				.gap(8)
				.x(d3.scale.ordinal().domain(["0", "1", "2", "3", "4", "5+"]))
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
				
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
		};
		
		//Top Institutions Chart
		function drawTopIstitucion() {
			var dim = ndx.dimension (function(d) {
				return d.nombreInstitucion;
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(20).filter(function(d) {
							return (d.key != "Not mentioned" && d.value != 0);
						});
					}
				};
			})(group);
			var graph = dc.rowChart(".topistitucion")   
				.margins({top: 0, right: 3, bottom: 20, left: 3})
				.height(730)
				//.width(360)
				.gap(1)
				//.fixedBarHeight(20)
				.x(d3.scale.ordinal())
				.elasticX(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(filteredGroup);
		};
		
		function incomeRange (valor) {
			//var thisval = valor;
			//alert(thisval);
			/*
			if(isNaN(thisval)){
				alert(thisval);
				if(thisval == "A"){thisval = 9904720}
				else if(thisval == "B" || thisval == "1-B"){thisval = 9121809}
				else if(thisval == "C"){thisval = 8393125}
				else if(thisval == "Dieta Parlmentaria"){thisval = 9121809}
				else {
					thisval = "N/A";
				}
			}
			*/
			valor = parseInt(valor);
			if (valor <= 50000 ) return "<= MM$50"; 
			if (valor < 100000 ) return "MM$50 - MM$100"; 
			if (valor < 500000 ) return "MM$100 - MM$500"; 
			if (valor < 1000000 ) return "MM$500 - MM$1000"; 
			if (valor < 5000000 ) return "MM$1000 - MM$5000"; 
			if (valor < 10000000 ) return "MM$5000 - MM$10000"; 
			return "> MM$10000";
		}
		
		//Income
		function drawIncome () {
			var dim = ndx.dimension (function(d) {
				//return incomeRange(d.Grado);
				//alert(d.accionestot + ' ' + d.valorestot + ' ' + (d.accionestot + d.valorestot));
				return incomeRange(d.accionestot + d.valorestot);
			});
			var group = dim.group().reduceSum(function(d) { return 1; });

			/*
			var graph = dc.barChart(".income")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(350)
				//.width(165)
				.gap(8)
				.x(d3.scale.ordinal().domain(["", "<= MM$50", "MM$50 - MM$100", "MM$100 - MM$500", "MM$500 - MM$1000", "MM$1000 - MM$5000", "MM$5000 - MM$10000", "> MM$10000"]))
				//.x(d3.scale.ordinal().domain(dim)) 
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
			*/
			
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
			var graph = dc.rowChart(".income")  
				.height(350)
				.gap(8)
				.elasticX(true)
				.dimension(dim)
				.group(group);
		};
		
		function accionesRange (valor) {
			valor = parseInt(valor);
			if (valor === 0 ) return "0"; 
			if (valor < 10000000 ) return "1 - 10M"; 
			if (valor < 50000000 ) return "10M - 50M"; 
			if (valor < 100000000 ) return "50M - 100M"; 
			if (valor < 1000000000 ) return "100M - 1B"; 
			return "> 1 Billón";
		}
		
		//accionesval
		function drawAccionesVal () {
			var dim = ndx.dimension (function(d) {
			//alert(d.toSource());
				//return accionesRange(d.accionestot);
				return accionesRange(d.accionestot + d.valorestot);
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var graph = dc.barChart(".accionesval")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(300)
				//.width(165)
				.gap(18)
				.x(d3.scale.ordinal().domain(["0", "1 - 10M", "10M - 50M", "50M - 100M", "100M - 1B", "> 1 Billón"])) // Need empty val to offset first value
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
				
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
		};
		
		function totRange (valor) {
			valor = parseInt(valor);
			if (valor <= 50000 ) return "<= MM$50"; 
			if (valor < 100000 ) return "MM$50 - MM$100"; 
			if (valor < 500000 ) return "MM$100 - MM$500"; 
			if (valor < 1000000 ) return "MM$500 - MM$1000"; 
			if (valor < 5000000 ) return "MM$1000 - MM$5000"; 
			if (valor < 10000000 ) return "MM$5000 - MM$10000"; 
			return "> MM$10000";
		}
		
		function drawTotVal () {
			var dim = ndx.dimension (function(d) {
			//alert(d.toSource());
				//return accionesRange(d.accionestot);
				return accionesRange(d.activotot);
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });

			var graph = dc.barChart(".totval")   
				.margins({top: 10, right: 3, bottom: 20, left: 30})
				.height(300)
				//.width(165)
				.gap(18)
				//.x(d3.scale.ordinal().domain(["", "<= MM$50", "MM$50 - MM$100", "MM$100 - MM$500", "MM$500 - MM$1000", "MM$1000 - MM$5000", "MM$5000 - MM$10000", "> MM$10000"]))
				.x(d3.scale.ordinal().domain(["0", "1 - 10M", "10M - 50M", "50M - 100M", "100M - 1B", "> 1 Billón"])) // Need empty val to offset first value
				.xUnits(dc.units.ordinal)
				.elasticY(true)
				.colorCalculator(function(d, i) {
					return "#84c0e9";
				})
				//.ordering(function(d){return -d.value})
				.dimension(dim)
				.group(group);
				
			//graph.yAxis().ticks(5).tickFormat(d3.format("d"));
		};
		
		//topprofessions
		function drawProfessions() {
			var dim = ndx.dimension (function(d) {
					return d.Profesion;  
			});
			var group   = dim.group().reduceSum(function(d) {   return 1; });
			/*
			var typecolor = {			
				"0":"#8da9db",
				"1 - 4":"#a8d08c",
				"5 +":"#f4b081"
			};
			*/
			var chart = dc.pieChart(".topprofessions")
				.innerRadius(0).radius(130)
				//.margins({top: 0, right: 3, bottom: 20, left: 3})
				.cy(130)
				.height(460)
				.dimension(dim)
				.cap(9)
				.group(group)				
				/*				
				.colorCalculator(function(d, i) {
					return typecolor[d.key];
				});
				*/
				chart.legend(dc.legend().x(30).y(280).itemHeight(13).gap(5))
				//chart.legend(dc.legend().x(30).y(280).itemHeight(13).gap(5).horizontal(true).itemWidth(290))
				
			
		}

		//Top 10 guests chart
		function drawTopGuest () {
			var dim = ndx.dimension (function(d) {
				return d.nombreEntidadActivo;
			});	
			var group = dim.group().reduceSum(function(d) { return 1; });
			var filteredGroup = (function(source_group) {
				return {
					all: function() {
						return source_group.top(11).filter(function(d) {
						return (d.key != "" && d.key != "Unknown" && d.key != "Not mentioned" && d.value != 0);
					});
				}
			};
		})(group);
		var graph = dc.rowChart(".guest")   
			.margins({top: 0, right: 3, bottom: 20, left: 3})
			.height(370)
			.width(165)
			.gap(3)
			.x(d3.scale.ordinal())
			.elasticX(true)
			.colorCalculator(function(d, i) {
				return "#ecb005";
			})
			.ordering(function(d){return -d.value})
			.dimension(dim)
			.group(filteredGroup);

			graph.xAxis().ticks(5).tickFormat(d3.format("d"));	
		};

		//Datatables table
		function drawTable () {
			var count=0;

			datatable = $(".table").dataTable({
				"columnDefs": [ {
				  "searchable": false,
				  "orderable": false,
				  "targets": 0,   
				  data: function ( row, type, val, meta ) {
					count++;
					return count;
				  }
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 1,
				  "defaultContent":"N/A",
				  "data":"fullName",
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 2,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.Cargo; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 3,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.party; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 4,
				  "defaultContent":"0",
				  "data": function (d, type, val, meta) {
					 if (!d.activity) return "";
					 return d.activity.length; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 5,
				  "defaultContent":"0",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.inmueble.length; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 6,
				  "defaultContent":"0",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.acciones.length; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 7,
				  "defaultContent":"0",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.mueble.length; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 8,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 return d.activotot; 
					},
				  },{
				  "searchable": false,
				  "orderable": true,
				  "targets": 9,
				  "defaultContent":"N/A",
				  "data": function (d, type, val, meta) {
					 if (!d) return "";
					 if(d.valores.length > 0 || d.agua.length > 0){
						return "SI";
					 }
					 return ""; 
					},
				  }
				],
				"iDisplayLength" : 100,
				"bPaginate": true,
				"bLengthChange": false,
				"bFilter": false,
				"order": [[ 1, "desc" ]],
				"bSort": true,
				"bInfo": false,
				"bAutoWidth": false,
				"bDeferRender": true,
				"aaData": nameEvent.top(Infinity),
				"bDestroy": true,
			});
			
			function addcommas(x){
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			}
		
			function countmeetings(who){
				var countedmeetings = _.filter(events, function(event, index) {
				  return event.nombrePasivoFull == who || event.nombreActivoFull == who;
				});
				return countedmeetings.length;
			}
			
			function renumeradoToText(ren){
				if(ren == 1){
					return "Si";
				} else if(ren == 0){
					return "No";
				}
				return "N/A";
			}
			
			function cleanDate(date){
				if(date){
					var thisdate = date.split(" ");
					return thisdate[0];
				}
				return "/";
			}
			function cleanAmount(x){
				var cleanamount = x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
				return cleanamount + " CLP";
			}
			
			function format (d) {				
				if (!d) return "no data";
				var monthNames = [
				  "January", "February", "March",
				  "April", "May", "June", "July",
				  "August", "September", "October",
				  "November", "December"
				];
				//alert(d.toSource());
				var day = d.date.getDate();
				var monthIndex = d.date.getMonth();
				var year = d.date.getFullYear();
				var thisdate = day + ' ' + monthNames[monthIndex] + ' ' + year;
				//var thishost = _.find(meetingspages, function (x) { return x.name == d.host });
				s = "<div class='l_data_container'>";
				s += "<div class='row'>";
				s += "<div class='col-md-6'>";
				s += "<div class='l_name'><label>Nombre</label> "+d.fullName+"</div>";
				s += "<div class='l_name'><label>Cargo</label> "+d.Cargo+"</div>";
				s += "<div class='l_name'><label>Partido</label> "+d.party+"</div>";
				s += "<div class='l_name'><label>Fecha assume el cargo</label> "+cleanDate(d.Datos_Entidad_Por_La_Que_Declara.Fecha_Asuncion_Cargo)+"</div>";
				s += "</div><div class='col-md-6'><div class='row'><div class='col-md-6'>";
				s += "<div class='salario-box-1'><strong>Salario Bruto</strong><br />"+d.gradoNum+"</div>";
				s += "</div><div class='col-md-6'>";
				s += "<div class='salario-box-2'><strong>Valor Total Activos</strong><br />"+cleanAmount(d.activotot)+"</div>";
				s += "</div></div></div></div><div class='infobox-divider'></div>";
				
				s += "<div class='row'><div class='col-md-12'>";
				
				s += "<div class='l_name'><label>Actividades que realiza</label> "+d.activity.length+"</div>";
				if(d.activity.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Tipo de actividad</th><th>Rubro</th><th>Realizada Para</th><th>Renumerada</th><th>Fecha inicio</th></tr></thead><tbody>";
				}
				_.each(d.activity, function (a) {
					
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Tipo_Actividad.nombre+"</td><td>"+a.Rubro.nombre+"</td><td>"+a.Nombre_Razon_Social+"</td><td>"+a.Clasificacion.nombre+"</td><td>"+cleanDate(a.Fecha_Inicio)+"</td></tr>";
				});
				if(d.activity.length > 0){
					s += "</tbody></table>";
				}
				
				s += "<div class='l_name'><label>Empresas (acciones)</label> "+d.acciones.length+"</div>";
				if(d.acciones.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Titulo</th><th>Entidad</th><th>Cantidad</th><th>Fecha</th><th>Controlador</th></tr></thead><tbody>";
				}
				_.each(d.acciones, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Titulo_Derecho_Accion.nombre+"</td><td>"+a.Nombre_Razon_Social+"</td><td>"+a.Cantidad_Porcentaje+"</td><td>"+cleanDate(a.Fecha_Adquisicion)+"</td><td>"+a.Tiene_Calidad_Controlador+"</tr>";
				});
				if(d.acciones.length > 0){
					s += "</tbody></table>";
				}
				
				s += "<div class='l_name'><label>Propriedades</label> "+d.inmueble.length+"</div>";
				if(d.inmueble.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Region</th><th>Fecha de adquisición</th><th>Forma</th><th>Domicilio</th><th>Avalúo Fiscal</th></tr></thead><tbody>";
				}
				_.each(d.inmueble, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Region.nombre+"</td><td>"+cleanDate(a.Fecha_Adquisicion)+"</td><td>"+a.Forma_Propiedad.nombre+"</td><td>"+a.Es_Su_Domicilio+"</td><td>"+a.Avaluo_Fiscal+"</td></tr>";
				});
				if(d.inmueble.length > 0){
					s += "</tbody></table>";
				}
				
				s += "<div class='l_name'><label>Vehiculos</label> "+d.mueble.length+"</div>";
				if(d.mueble.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Typo</th><th>Marca</th><th>Modelo</th><th>Año de fabricación</th><th>Avalúo Fiscal</th></tr></thead><tbody>";
				}
				_.each(d.mueble, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Tipo_Vehiculo.nombre+"</td><td>"+a.Marca.nombre+"</td><td>"+a.Modelo+"</td><td>"+a.Annio_Fabricacion+"</td><td>"+a.Avaluo_Fiscal+"</td></tr>";
				});
				if(d.mueble.length > 0){
					s += "</tbody></table>";
				}
				
				s += "<div class='l_name'><label>Instrumento o valor transable</label> "+d.valores.length+"</div>";
				if(d.valores.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Titulo</th><th>Emissor</th><th>Fecha de adquisición</th><th>Pais</th><th>Valor</th></tr></thead><tbody>";
				}
				_.each(d.valores, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Titulo_Documento.nombre+"</td><td>"+a.Nombre_Razon_SocialEmisor+"</td><td>"+cleanDate(a.Fecha_Adquisicion)+"</td><td>"+a.Pais_Emision_Valores.nombre+"</td><td>"+a.Valor_Corriente_Plaza+"</td></tr>";
				});
				if(d.valores.length > 0){
					s += "</tbody></table>";
				}
				
				s += "<div class='l_name'><label>Contratos y administracion de valores</label> /</div>";
				s += "No tiene información declarada en esta sección";
				
				s += "<div class='l_name'><label>Aguas Concesiones</label> "+d.agua.length+"</div>";
				if(d.agua.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Region</th><th>Emisora</th><th>Año de resolución</th><th>Tipo</th><th>Naturaleza del agua</th></tr></thead><tbody>";
				}
				_.each(d.agua, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Region.nombre+"</td><td>"+a.Entidad_Emisora.nombre+"</td><td>"+a.Annio_Resolucion+"</td><td>"+a.Tipo_Derecho.nombre+"</td><td>"+a.Naturaleza_Agua.nombre+"</td></tr>";
				});
				if(d.agua.length > 0){
					s += "</tbody></table>";
				}
				if(d.pasivos.length == 0 && d.pasivostot != 0){
					s += "<div class='l_name'><label>Pasivos</label> "+d.pasivostot+"</div>";
				} else {
					s += "<div class='l_name'><label>Pasivos</label> "+d.pasivos.length+"</div>";
				}
				if(d.pasivos.length > 0){
					s += "<table style='width:100%;'><thead><tr><th>Tipo</th><th>Acreedor</th><th>Monto adeuado</th></tr></thead><tbody>";
				}
				_.each(d.pasivos, function (a) {
					s += "<tr style='border-bottom:1px solid #eee;'><td>"+a.Tipo_Obligacion_Deuda.nombre+"</td><td>"+a.Nombre_Razon_Social_Acreedor+"</td><td>"+a.Monto_Adeudado_Pesos+"</td></tr>";
				});
				if(d.pasivos.length > 0){
					s += "</tbody></table>";
				}

				
				s += "<div class='l_name'><label>Otras Fuentes de conflicto de intereses</label> /</div>";
				s += "No tiene información declarada en esta sección";
				
				s += "<div><label>Link declaracion completa:</label><br /><a href='http://www.infoprobidad.cl/Declaracion/Declaracion?ID="+d.Id_Declaracion+"' target='_blank'>http://www.infoprobidad.cl/Declaracion/Declaracion?ID="+d.Id_Declaracion+"</a></div>";
				
				s  += "</div></div>";
				
				return s;
			}	
			//Datatables click function
			datatable.on('click', 'button', function () {
				var tr = $(this).closest('tr');
				var type=$(this).data("type");
				var pre=$(this).parent().parent().next("pre");
				var row = datatable.DataTable().row( tr.prev()[0] );
				var d=row.data();
			 
				if (type == "event") {
					var sevents =[];
					_.each(events,function (e){
					if (e.guestid == d.id)
					  sevents.push(e);
					});
					pre.html(JSON.stringify(sevents,null,2));
					return;
				}

				var r = (tr.data("representative"));
				if (!r) {
				  url="http://api.lobbyfacts.eu/api/1/representative/"+d.id+"?callback=?";
				  $.getJSON( url, function( data ) {
					tr.data("representative",data);
					display (data);
				  });
				  return;
				}
				display(r,type);

				function display (data) {
				  switch (type) {
					case "financial_data":
					 pre.html(JSON.stringify(data["financial_data"],null,2));
					  break;
					case "accreditation":
					 pre.html(JSON.stringify(data["accreditations"],null,2));
					  break;
					default:
					  pre.html(JSON.stringify(data,null,2));
				  }
				}
				
			});
		
			datatable.DataTable().on('click', 'tr[role="row"]', function () {
				var tr = $(this);
				var row = datatable.DataTable().row( tr );
				if ( row.child.isShown() ) {
					// This row is already open - close it
					row.child.hide();
					tr.removeClass('shown');
				}
				else {
					// Open this row
					row.child( format(row.data()) ).show();
					tr.addClass('shown');
					var height1 = $('.l_data_container_host').height();
					var height2 = $('.l_data_container_guest').height();
					if(height1 > height2){
						$('.l_data_container_guest').height(height1);
					} else {
						$('.l_data_container_host').height(height2);
					}
				}
			});
			
			datatable.DataTable().on( 'order.dt search.dt page.dt draw.dt', function () {
				var thispage = $('.paginate_button.current').html();			
				var rowi = 0;
			  datatable.DataTable().column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
				if(rowi >= 100){
					rowi = 0;
				}
				rowi ++;
				if(thispage > 1){
					cell.innerHTML = (rowi) + (100*(thispage-1));
				} else {
					cell.innerHTML = (rowi);
				}
			  });

			});
		}
		//End datatable table function

	   function RefreshTable() {
			dc.events.trigger(function () {
				alldata = evt.top(Infinity);
				datatable.fnClearTable();
				datatable.fnAddData(alldata);
				datatable.fnDraw();
			});
		}

		dc.renderAll();
		hashFilter();   

	}
	//End grid function

	function getAmountString(d) {
		if (d.qty == 0) {
			return "";
		}
		if (d.max == Number.POSITIVE_INFINITY)
			return "<span class='q"+d.qty+"' title='"+d.qty.length+" different occupations'>"+d.min+" &euro; or more</span>";
		return d.min +" &#8605; "+d.max +"  &euro;";
	}

	function getAmount (category, field) { //field = min (default) or max or "string"
		field = field || "min";
		if (!category) return "?";
		if (isNaN(category)) return category;
		if (category < 0 && field == "min") return "0";
		if (category < 0 && field == "max") return "499";
		if (category < 0 && field == "string") return "0  &#8605; 499 &euro;";
		 
		if (category >=4 && field == "max") return "or more";
		if (category >=4 && field == "string") return rangeEUR[category]["min"] + " or more";
		if (field == "string")
			return  rangeEUR[category]["min"] + " &#8605; "+  rangeEUR[category]["max"];
		return rangeEUR[category][field];
	}

	function hashFilter () {
		var hash = window.location.hash;
		if(hash.indexOf('#mep') === 0) { 
			eventpopup(hash.substring(4));
			ga && ga('send', 'event', 'urlevent',hash.substring(4));
		}
	}
		 
	function eventpopup (epid) {
		window.location.hash = "event"+d.epid;
		ga && ga('send', 'event', 'clickevent',hash.substring(4));
	}

</script>


<nav class="navbar navbar-default" role="navigation">
	<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<div class="navbar-brand" id="ti_logo_container">
						<a id="ti_logo" href="http://www.chiletransparente.cl/">Transparency International</a>
						<a id="page_title" href="/" target="_blank">Integrity<br />Watch <strong>Chile</strong></a>
				</div>
			</div>
		
			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li id="cm_tool_btn"><a href="iw_chile.html"><strong>Audiencias</strong> <br />Gobierno Central</a></li>
					<li class="" id="cm_tool_btn"><a href="iw_chile_tab2.html"><strong>Audiencias</strong> <br />Congreso Nacional</a></li>
					<li class="active" id="cm_tool_btn"><a href="iw_chile_tab3.html"><strong>Declaraciones</strong> <br />de Interès y Patrimonio</a></li>
					<li class="dropdown">
						<a aria-expanded="false" aria-haspopup="true" role="button" data-toggle="dropdown" class="dropdown-toggle" href="#" style="width: 120px;">Otras versiones<span class="caret"></span></a>
						 <ul class="dropdown-menu">
							<li><a href="http://www.integritywatch.eu">Unión Europea</a></li>
						    <li><a href="http://www.integritywatch.fr">Francia</a></li>
							<li><a href="">Reino Unido</a></li>
						</ul>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="about_chile.html">¿Qué es integrity watch?</a></li>
					<li><a href="contact.html">Contacto</a></li>
				</ul>
			</div>
	 </div><!-- container -->
</nav>
<div class="container_wrap cm_header" id="about_wrap_top">&nbsp;</div>

<div class="container_wrap filter_cm" id="filter_wrap">
	<div class="container">
		<div class="row">
			<div class="col-md-4" id="filter_field_container">
				<p>Buscar o Filtrar:</p>
				<div class="input-group">
						<input type="text" id="search-input" class="form-control input-lg" placeholder="Filtrar par activo, pasivo o tema ...">
				</div>
			</div>
			<div class="col-md-7" id="filter_numbers">
				<div class="row">
					<div class="col-md-2" id="currently_selected_text"><p>Actualmente seleccionado:</p></div>
					
					<div class="col-md-2 filter_number">
						<div id="mep_number" class="dc-data-count">
							<span id="abig_number" class="big_number filter-count"></span>de cada <strong class="total-count"></strong><br /> declaraciones
						</div>
					</div>
					<!--
					<div class="col-md-2 filter_number">
						<div id="org_number" class="org-count">
							<span class="big_number filter-count"></span>out of <strong class="total-count"></strong><br />organisations
						</div>
					</div>
					-->

					</div>
				</div>
			<div class="col-md-1" id="resetall_container">
				<button class="btn resetall">RESTABLECER<br />FILTROS</button>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div class="col-md-4"></div>
	<div class="col-md-4"></div>
	<div class="col-md-4"></div>
</div>
<div id="ec">
	<div class="container_wrap" id="main_charts_wrap">
		<div class="container">
			<div class="row">
				<!-- COL1 -->
				<div class="col-md-5">
					<div class="chart_box">
						<h3>Institución<!--span class="info">info</span--></h3>
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">Filtrar los declaraciones de declaraciones de Interés y Patrimonio por la institucion de la Republica de Chile.</p>
						</div>
						<div class="filter_btn_container">
							<img src="./img/G1.png" id="gobierno_btn" /><img src="./img/C1.png" id="diputados_btn" /><img src="./img/S1.png" id="senado_btn" /><img src="./img/EL1.png" id="candidates_btn" />
						</div>
						<!--
						<div class="topistitucion chart-full"></div>
						<div class="label">Contacts</div>
						-->
						<br class="clear" />
					</div>
					<!-- TIPO -->
					<div class="chart_box infofix">
						<h3>Top 10 actividades profesionales<!--span class="info">info</span--></h3>
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">Las proporciones del gráfico circular refleja las 10 actividades profesionales más común declaradas por los funcionarios públicos. </p>
						</div>
						<div class="topprofessions chart-full"></div>
						<div class="label"></div>
						<br class="clear" />
					</div>
					<!--
					<div class="chart_box infofix" id="dectype">
						<h3>Tipo de declaraciones</h3>
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">La ley de Probidad en la Función Pública y Prevención de los Conflictos de Intereses define tres momentos para declarar: cuando asumen el cargo, anualmente en marzo de cada año (actualización) y cuando concluí sus funciones. Las proporciones del gráfico circular refleja el nombre de declaraciones por tipo.</p>
						</div>
						<div class="dectype"></div>
						<div class="legend">
						</div>
						<br class="clear" />
					</div>
					-->
				</div>
				<!-- COL2 -->
				<div class="col-md-7">
					<!-- CARGO -->
					<div class="chart_box" id="hosttype">
						<h3>Valor total activos<!--span class="info">info</span--></h3>
						<div class="info_chart">
							<span class="info">info</span>
							<p class="desc">Valor total de todos los activos declarados por los funcionarios públicos</p>
						</div>
						<!-- <div class="income"></div> -->
						<div class="totval chart-full"></div>
						<div class="legend">
						</div>
						<br class="clear" />
					</div>
					<!-- TOP10 -->
					<div class="row">
						<div class="col-md-6">
							<div class="chart_box">
								<h3>Proporción nombre de<br />actividades<!--span class="info">info</span--></h3>
								<div class="info_chart">
									<span class="info">info</span>
									<p class="desc">El gráfico circular refleja la proporcione de funcionarios por nombre de actividades profesionales cuando asumen su cargo.</p>
								</div>
								<div class="nactividades chart-full"></div>
								<div class="label"></div>
								<br class="clear" />
							</div>
						</div>
						<div class="col-md-6">
							<div class="chart_box" id="group_container">
								<h3>Proporción nombre de actividades (últimos 12 meses)</h3>
								<div class="info_chart">
									<span class="info">info</span>
									<p class="desc">El gráfico circular refleja la proporcione de funcionarios por nombre de actividades profesionales en los 12 meses antes de asumir su cargo.</p>
								</div>
									<div class="nproactividades chart-full"></div>
									<div class="label"></div>
								<br class="clear" />
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ADDITIONAL GRAPHS DIVIDER -->
			<div class="moregraphs">Ver más gráficos</div>
			<!-- ADDITIONAL GRAPHS -->
			<div id="detailCharts">
				<div class="row">
					<div class="col-md-4">
						<div class="chart_box">
							<h3>Nombre de<br />vehículo<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">El gráfico de barras refleja la proporcione de funcionarios por nombre de vehículos declarados</p>
							</div>
							<div class="vehicles chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4">
						<div class="chart_box">
							<h3>Nombre de<br />comunidades, sociedades, empresas<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">El gráfico de barras refleja la proporcione de funcionarios por nombre de sociedades, comunidades y empresas declarados.</p>
							</div>
							<div class="empresas chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					<div class="col-md-4">
						<div class="chart_box">
							<h3>Nombre de<br />bienes inmuebles<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">El gráfico de barras refleja la proporcione de funcionarios por nombre de bienes inmuebles declarados</p>
							</div>
							<div class="inmuebles chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
				</div>
				<div class="row">
					<!--
					<div class="col-md-6">
						<div class="chart_box">
							<h3>Top 10 actividades profesionales</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">Las proporciones del gráfico circular refleja las 10 actividades profesionales más común declaradas por los funcionarios públicos. </p>
							</div>
							<div class="topprofessions chart-full"></div>
							<div class="label"></div>
							<br class="clear" />
						</div>
					</div>
					-->
					<div class="col-md-6">
						<div class="chart_box" id="hosttype">
							<h3>Derechos o Acciones<!--span class="info">info</span--></h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc">El gráfico de barras refleja la proporcione de funcionarios por nombre de derechos y acciones declarados</p>
							</div>
							<!-- <div class="income"></div> -->
							<div class="accionesval chart-full"></div>
							<div class="legend">
							</div>
							<br class="clear" />
						</div>
						<!--
						<div class="chart_box" id="group_container">
							<h3>Acciones</h3>
							<div class="info_chart">
								<span class="info">info</span>
								<p class="desc"></p>
							</div>
								<div class="accionesval chart-full"></div>
								<div class="label"></div>
							<br class="clear" />
						</div>
						-->
					</div>
				</div>
			</div>
		</div>
	</div>	
</div>

<div class="container_wrap" id="list_container">
	<div class="container">
		<div class="row">
			<div class="content" id="list_content">
				<h2 class="table_title" style="width: 100%;">Funcionarios Público
					<div class="info_chart">
						<span class="info">info</span>
						<p class="desc">Haga clic en cualquier declaracion para obtener información adicional.</p>
					</div>
				</h2>
			</div>
			
			<div class="col-md-12 table-responsive">
				<table class="table table-hover dc-data-grid tablesorter-bootstrap">
					<thead>
						<tr class="header">
							<th class="header">Nr</th> 
							<th class="header">Nombre</th> 
							<th class="header">Cargo</th> 
							<th class="header">Partido</th> 
							<th class="header">Actividades</th> 
							<th class="header">Propriedades</th> 
							<th class="header">Empresas</th> 
							<th class="header">Vehículos</th>
							<th class="header">Valor total activos</th> 
							<th class="header">Activos adicionales</th> 
						</tr>
					</thead>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
	'use strict';

	//New subategories
	var newSubcat = {"Law firms":"Law firms","Professional consultancies":"Professional consultancies","Self-employed consultants":"Self-employed consultants","Companies & groups":"Companies & groups","Other in house lobbyists":"Other in house lobbyists","Trade and business organisations":"Trade and business organisations","Trade unions":"Trade unions","Trade unions and professional associations":"Trade unions","Trade, business & professional associations":"Unknown","Non-governmental organisations, platforms and networks and similar":"Non-governmental organisations, platforms and networks and similar","Academic institutions":"Academic institutions","Think tanks and research institutions":"Think tanks and research institutions","Organisations representing churches and religious communities":"Churches & religious communities","Local, regional and municipal authorities (at sub-national level)":"Unknown","Other public or mixed entities, created by law whose purpose is to act in the public interest":"Other public or mixed entities","Other public or mixed entities, etc.":"Other public or mixed entities","Other sub-national public authorities":"Other sub-national public authorities","Regional structures":"Regional structures","Transnational associations and networks of public regional or other sub-national authorities":"Transnational public networks","Unknown":"Unknown"};

	//Set last updates as yesterday's date
	var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September", "October", "November", "December"];
	var updatedate = new Date();
	updatedate.setDate(updatedate.getDate() - 1);
	$('#updatedate').html(updatedate.getDate() + ' ' + monthNames[updatedate.getMonth()] + ' ' + updatedate.getFullYear());

	var decl = [];
	var events=[];
	var activity=[];
	var inmueble=[];
	var mueble=[];
	var acciones=[];
	var valores=[];
	var pasivos=[];
	
	var partiesSenate = [];
	var parties = [];
	
	var moreinfo = [];
	
	var meetingspages;
	var evt=null;
	var nameEvent=null;
	var representatives={};
	var countriesISO={};
		
	String.prototype.capitalize = function() {
		return this.charAt(0).toUpperCase() + this.slice(1);
	}
	
	function getFullName(d){
		return d.NombreDeclarante + ' ' + d.ApellidoPaternoDeclarante + ' ' + d.ApellidoMaternoDeclarante;
	}
	
	function getFullNameJson(d){
		return d.nombre + ' ' + d.Apellido_Paterno + ' ' + d.Apellido_Materno;
	}
	function getFullNameJson2(d){
		return d.nombre.split(" ")[0] + ' ' + d.Apellido_Paterno + ' ' + d.Apellido_Materno;
	}
	
	$(function() {
		var renderLoaded  = _.after(2,  function () { 
			//var dateFormat = d3.time.format("%Y-%m-%d %H:%M:%S");
			var dateFormat = d3.time.format("%d/%m/%Y");
			var dateFormatJson = d3.time.format("%Y/%m/%d");
			var now = Date.now();
			var a;
			_.each (decl, function (d) {
				//alert(d.Datos_del_Declarante.toSource());
				d.date = d.Fecha_de_la_Declaracion.split(" ")[0];
				d.date = dateFormatJson.parse(d.date);
				d.fullName = getFullNameJson(d.Datos_del_Declarante);
				d.fullName2 = getFullNameJson2(d.Datos_del_Declarante);
				//alert(d.date + ' ' + d.fullName);
				
				//PARTY
				d.party = "";
				d.party = _.find(parties,function (m) { return m.Diputado.toLowerCase() == d.fullName.toLowerCase() });
				if(d.party){
					d.party = d.party.Partido;
				} else {
					var thisPartySenate = _.find(partiesSenate,function (m) { return m.Name.toLowerCase() == d.fullName.toLowerCase() });
					if(thisPartySenate){
						d.party = thisPartySenate.Partido.trim();
					} else {
						d.party = "N/A";
					}
				}
				
				d.grado = d.Datos_Entidad_Por_La_Que_Declara.Grado_Renta_Mensual;
				
				//More data
				d.moreinfo = _.find(moreinfo,function (m) { return m.Nombre.toLowerCase() == d.fullName2.toLowerCase() });
				if(!d.moreinfo){
					d.moreinfo = _.find(moreinfo,function (m) { return m.Nombre.toLowerCase() == d.fullName.toLowerCase() });
				}
				//alert(d.fullName + ' ' +d.moreinfo);
				if(d.moreinfo){
					d.party = d.moreinfo.Partido;
					d.grado = d.moreinfo.Grado;
				}
				
				d.gradoNum = d.grado;
				if(d.grado == "DIETA PARLEMENTARIA" || d.grado == "DIETA"){
					d.gradoNum = "9.121.809 CLP";
				} else if(d.grado == "A" || d.grado == "GRADO A"){
					d.gradoNum = "9.904.720 CLP";
				} else if(d.grado == "B" || d.grado == "GRADO B" || d.grado == "1-B" || d.grado == "1B"){
					d.gradoNum = "9.121.809 CLP";
				} else if(d.grado == "C" || d.grado == "GRADO C" || d.grado == "1C"){
					d.gradoNum = "8.393.125 CLP";
				}
				
				d.activity = [];
				d.activityPro = [];
				d.mueble = [];
				d.inmueble = [];
				d.pasivos = [];
				d.valores = [];
				d.acciones = [];
				d.agua = [];
				
				//PASIVOS Total
				d.pasivostot = 0;

				
				if(d.Actividades_Profesionales_A_La_Fecha){
					d.activity = d.Actividades_Profesionales_A_La_Fecha;
				}
				if(d.Actividades_Profesionales_Ultimos_12_Meses){
					d.activityPro = d.Actividades_Profesionales_Ultimos_12_Meses;
				}
				if(d.Vehiculos_Motorizados){
					d.mueble = d.Vehiculos_Motorizados;
				}
				if(d.Bienes_Inmuebles_Situados_En_Chile){
					d.inmueble = d.Bienes_Inmuebles_Situados_En_Chile;
				}
				if(d.Pasivos){
					if(d.Pasivos.Monto_Global_Pesos){
						d.pasivostot = d.Pasivos.Monto_Global_Pesos;
					}
					if(d.Pasivos.Individualiza_Deudas){
						d.pasivos = d.Pasivos.Individualiza_Deudas;
					}
				}
				//d.Pasivos.Individualiza_Deudas;
				if(d.Instrumentos_Valor_TransableChile){
					d.valores = d.Instrumentos_Valor_TransableChile;
				}
				if(d.Derechos_Acciones_Chile){
					d.acciones = d.Derechos_Acciones_Chile;
				}
				if(d.Derecho_Aprovechamiento_De_Aguas){
					d.agua = d.Derecho_Aprovechamiento_De_Aguas;
				}
				
				
				//CALCULATE AMOUNTS
				d.accionestot = 0;
				_.each (d.acciones, function (t) {
					if(t.Valor_Corriente_Plazo_Valor_Libro){
					 d.accionestot += parseInt(t.Valor_Corriente_Plazo_Valor_Libro);
					}
				});
				
				d.valorestot = 0;
				_.each (d.valores, function (t) {
					if(t.Valor_Corriente_Plaza){
					 d.valorestot += parseInt(t.Valor_Corriente_Plaza);
					}
				});
				
				d.mueblestot = 0;
				_.each (d.mueble, function (t) {
					if(t.Avaluo_Fiscal){
					 d.mueblestot += parseInt(t.Avaluo_Fiscal);
					}
				});
				
				d.inmueblestot = 0;
				_.each (d.inmueble, function (t) {
					if(t.Avaluo_Fiscal){
					 d.inmueblestot += parseInt(t.Avaluo_Fiscal);
					}
				});
				
				d.activotot = d.accionestot + d.valorestot + d.mueblestot + d.inmueblestot;
				
				//alert(d.activotot);
				
				//CARGO
				d.Cargo = "";
				/*
				if(d.Datos_Entidad_Por_La_Que_Declara.Servicio_Entidad.nombre){
					d.Cargo = d.Datos_Entidad_Por_La_Que_Declara.Servicio_Entidad.nombre;
					alert(d.Cargo);
				} else 
				*/
				
				if(d.Datos_Entidad_Por_La_Que_Declara.Cargo_Funcion.nombre){
					d.Cargo = d.Datos_Entidad_Por_La_Que_Declara.Cargo_Funcion.nombre;
				}
				/*
				if(d.Cargo.toLowerCase() != "gobernador" && d.Cargo.toLowerCase()  != "intendente" && d.Cargo.toLowerCase() != "ministro" && d.Cargo.toLowerCase()  != "subsecretario" && d.Cargo.toLowerCase()  != "diputado" && d.Cargo.toLowerCase() != "senador" && d.Cargo.toLowerCase()  != "candidato" && d.Cargo.toLowerCase() != "senador(a)" && d.Cargo.toLowerCase()  != "diputado/da" && d.Cargo != "CANDIDATO ELECCIONES PRIMARIAS 2017"){
					alert(d.Cargo + ": " + d.Id_Declaracion);
				}
				*/
				//PROFESSION
				d.Profesion = "";
				if(d.Datos_del_Declarante.Profesion_Oficio.nombre){
					d.Profesion = d.Datos_del_Declarante.Profesion_Oficio.nombre;
				}
				//TIPO DECLARACIONES
				d.Tipo = d.Tipo_Declaracion.nombre;
				if(d.Tipo == "PRIMERA DECLARACION (POR ASUNCION DE CARGO)"){
					d.Tipo = "PRIMERA DECLARACIÓN (POR ASUNCIÓN DE CARGO)";
				}
				if(d.Tipo == "PRESENTACION A REQUERIMIENTO DE ORGANO FISCALIZADOR" || d.Tipo == "PRESENTACIÓN A REQUERIMIENTO  DE ORGANO FISCALIZADOR"){
					d.Tipo = "PRESENTACIÓN A REQUERIMIENTO DE ORGANO FISCALIZADOR";
				}	

			});
			grid ("#ec",decl);
			$('#detailCharts').hide();
			
			//Loop through dataset and fix/adjust data
			/*
			_.each (events, function (d) {

				d.date = dateFormat.parse(d.FDeclaracion);
				d.fullName = getFullName(d);
				
				
				//Party
				
				d.party = "";
				d.party = _.find(parties,function (m) { return m.Diputado.toLowerCase() == d.fullname });
				
				if(d.party){
					d.party = d.party.Partido;
				} else {
					var thisPartySenate = _.find(partiesSenate,function (m) { return m.Name.toLowerCase() == d.fullname });
					if(thisPartySenate){
						d.party = thisPartySenate.Partido.trim();
					} else {
						//alert(d.fullname);
						d.party = "N/A";
					}
				}
				
				//alert(d.fullName);
				
				var thisActivity = _.filter(activity, function(a) {
					return getFullName(a) == getFullName(d);
				});
				var thisActivityProf = _.filter(thisActivity, function(a) {
					return a.TipoActividad == 'PROFESIONAL';
				});
				var thisInmueble = _.filter(inmueble, function(a) {
					return getFullName(a) == getFullName(d);
				});
				var thisMueble = _.filter(mueble, function(a) {
					return getFullName(a) == getFullName(d);
				});
				var thisAcciones = _.filter(acciones, function(a) {
					return getFullName(a) == getFullName(d);
				});
				var thisValores = _.filter(valores, function(a) {
					return getFullName(a) == getFullName(d);
				});
				var thisPasivos = _.filter(pasivos, function(a) {
					return getFullName(a) == getFullName(d);
				});
				
				d.activity = thisActivity;
				d.activityPro = thisActivityProf;
				d.inmueble = thisInmueble;
				d.mueble = thisMueble;
				d.acciones = thisAcciones;
				d.valores = thisValores;
				d.pasivos = thisPasivos;
				
				d.accionestot = 0;
				_.each (d.acciones, function (t) {
					d.accionestot += parseInt(t.Valor);
				});
				
				d.valorestot = 0;
				_.each (d.valores, function (t) {
					d.valorestot += parseInt(t.ValorPlaza);
				});
				
				d.mueblestot = 0;
				_.each (d.mueble, function (t) {
					d.mueblestot += parseInt(t.Avaluo);
				});
				
				d.inmueblestot = 0;
				
				d.activotot = d.accionestot + d.valorestot + d.mueblestot + d.inmueblestot;
				
				//alert(d.toSource());
				
			});
			*/
			//End loop through dataset
			
			//Call grid function to create and display charts
			//grid ("#ec",events);
		});
		//End RenderLoaded
		
		//Load datasets
		  
		

		d3.csv("data/iw-chile-party.csv", function (rows) {
			parties = rows;
		});
		d3.csv("data/iw-chile-party-senate.csv", function (rows) {
			partiesSenate = rows;
			//renderLoaded();
		});
		d3.csv("data/partidos-grados.csv", function (rows) {
			moreinfo = rows;
			renderLoaded();
		});
		d3.json("data/declaraciones.json", function (rows) {
			decl = rows;
			renderLoaded();
		}); 
		
		
		
		//Filter buttons
		var diputadosfilter = false;
		var senadofilter = false;
		var gobiernofilter = false;
		var candidatofilter = false;

		//Gobierno filter
		$("#gobierno_btn").click(function() {
			if($("#senado_btn").attr("src") == "img/S2.png" && $("#diputados_btn").attr("src") == "img/C2.png" && $("#candidates_btn").attr("src") == "img/EL2.png"){
				$(".resetall").click();
				return;
			}
			gobiernofilter = true;
			diputadosfilter = false;
			senadofilter = false;
			candidatofilter = false;
			nameEvent.filter(function (d) { 
				//alert(d);
				return d.indexOf("cargo:gobernador") !== -1 || d.indexOf("cargo:intendente") !== -1 || d.indexOf("cargo:ministr") !== -1 || d.indexOf("cargo:subsecretari") !== -1 || d.indexOf("id:111739") !== -1 || d.indexOf("id:23461") !== -1 || d.indexOf("id:34594") !==- 1 || d.indexOf("id:45535") !== -1;
			});
			$("#gobierno_btn").attr("src", "img/G1.png");
			$("#diputados_btn").attr("src", "img/C2.png");
			$("#senado_btn").attr("src", "img/S2.png");
			$("#candidates_btn").attr("src", "img/EL2.png");
			//countOfficialsWall(wall.dimension().top(Infinity));
			dc.redrawAll();
		});
		//Diputados filter
		$("#diputados_btn").click(function() {
			if($("#senado_btn").attr("src") == "img/S2.png" && $("#gobierno_btn").attr("src") == "img/G2.png" && $("#candidates_btn").attr("src") == "img/EL2.png"){
				$(".resetall").click();
				return;
			}
			gobiernofilter = false;
			diputadosfilter = true;
			senadofilter = false;
			candidatofilter = false;
			nameEvent.filter(function (d) { 
				//alert(d);
				return d.indexOf("cargo:diputado") !== -1 || d.indexOf("cargo:camara") !== -1;
			});
			$("#gobierno_btn").attr("src", "img/G2.png");
			$("#diputados_btn").attr("src", "img/C1.png");
			$("#senado_btn").attr("src", "img/S2.png");
			$("#candidates_btn").attr("src", "img/EL2.png");
			//countOfficialsWall(wall.dimension().top(Infinity));
			dc.redrawAll();
		});
		$("#senado_btn").click(function() {
			if($("#diputados_btn").attr("src") == "img/C2.png" && $("#gobierno_btn").attr("src") == "img/G2.png" && $("#candidates_btn").attr("src") == "img/EL2.png"){
				$(".resetall").click();
				return;
			}
			gobiernofilter = false;
			diputadosfilter = false;
			senadofilter = true;
			candidatofilter = false;
			nameEvent.filter(function (d) { 
				//alert(d);
				return d.indexOf("cargo:senado") !== -1 || d.indexOf("id:106924") !==- 1;
			});
			$("#gobierno_btn").attr("src", "img/G2.png");
			$("#diputados_btn").attr("src", "img/C2.png");
			$("#senado_btn").attr("src", "img/S1.png");
			$("#candidates_btn").attr("src", "img/EL2.png");
			//countOfficialsWall(wall.dimension().top(Infinity));
			dc.redrawAll();
		});
		$("#candidates_btn").click(function() {
			if($("#diputados_btn").attr("src") == "img/C2.png" && $("#gobierno_btn").attr("src") == "img/G2.png" && $("#senado_btn").attr("src") == "img/S2.png"){
				$(".resetall").click();
				return;
			}
			gobiernofilter = false;
			diputadosfilter = false;
			senadofilter = false;
			candidatofilter = true;
			nameEvent.filter(function (d) { 
				//alert(d);
				return d.indexOf("cargo:candidat") !== -1;
			});
			$("#gobierno_btn").attr("src", "img/G2.png");
			$("#diputados_btn").attr("src", "img/C2.png");
			$("#senado_btn").attr("src", "img/S2.png");
			$("#candidates_btn").attr("src", "img/EL1.png");
			//countOfficialsWall(wall.dimension().top(Infinity));
			dc.redrawAll();
		});
	
		

		//Search field function
		$("#search-input").keyup (function () {
			var s = $(this ).val().toLowerCase();
			nameEvent.filter(function (d) { 
				return d.indexOf (s) !== -1;} );
			$(".resetall").attr("disabled",false);
			throttle();
			var throttleTimer;
			function throttle() {
				window.clearTimeout(throttleTimer);
				throttleTimer = window.setTimeout(function() {
					console.log ("redraw");
						dc.redrawAll();
				}, 250);
			}
		});
		
		//Reset button
		$(".resetall").click(function() {
			nameEvent.filter(null);
			dc.filterAll();
			dc.renderAll();
			$("#search-input").val("");
			//$(".resetall").attr("disabled",true);
			$("#gobierno_btn").attr("src", "img/G1.png");
			$("#diputados_btn").attr("src", "img/C1.png");
			$("#senado_btn").attr("src", "img/S1.png");
			$("#candidates_btn").attr("src", "img/EL1.png");
			diputadosfilter = false;
			senadofilter = false;
			gobiernofilter = false;
			candidatofilter = false;
			//jQuery( ".topprofessions g text:contains('Others')" ).text('Otros');
		}); 
		
		$(".moregraphs").click(function() {
			$('#detailCharts').toggle();
			$(".resetall").click();
		});
	});      

</script>



<script>
	//Google Analytics
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-55613514-1', 'auto');
	ga('send', 'pdateview');
</script>
</body>
</html>
